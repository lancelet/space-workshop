\documentclass[12pt,openany]{book}

%------------------------------------------------------------------------------
% PRELUDE
%------------------------------------------------------------------------------

% Don't pause on errors (useful for CI)
\nonstopmode

% Font encoding
\usepackage[T1]{fontenc}

% Set fonts
\usepackage{fontspec}
\setmainfont{Tex Gyre Pagella}
\setsansfont{Tex Gyre Adventor}

% Set up page geometry (margins, etc)
\usepackage[a4paper,top=2.5cm,bottom=2.5cm,left=2cm,right=2cm]{geometry}

% Allow inclusion of external graphics with graphicx
\usepackage{graphicx}

% AMS mathematics
\usepackage{amsmath}

% Bibliography style
\usepackage[numbers]{natbib}

% Hyperlinks
\usepackage[breaklinks,hidelinks]{hyperref}

% More sophisticated tables
\usepackage{booktabs}

% Formatting chemical isotopes
\usepackage{isotope}

% Caption customization
\usepackage[format=hang,labelfont=bf]{caption}

% Color specification
\usepackage{xcolor}

% Color boxes
\usepackage{tcolorbox}
\tcbuselibrary{skins}
\definecolor{midpurple}{RGB}{93,76,134}
\definecolor{vlightgrey}{RGB}{240,240,240}

% Problem boxen
\newtcolorbox[auto counter]{problem}[2][]{%
  colback=vlightgrey,colframe=midpurple,fonttitle=\bfseries,
  title=Problem~\thetcbcounter: #2,#1}

% Fancy headers
\usepackage{fancyhdr}
\pagestyle{plain}

% Set the title of the table of contents and bibliography
\renewcommand{\contentsname}{Table of Contents}
\renewcommand{\bibname}{References}

% Paragraph setting
\setlength{\parindent}{0em}
\setlength{\parskip}{1.1\baselineskip}
\linespread{1.1}

% Enumerate and itemize *within* paragraphs
\usepackage{enumitem}
\newlist{paritemize}{itemize}{1}
\setlist[paritemize]{label=\textbullet,nosep,topsep=-0.75\parskip}
\newlist{probitemize}{itemize}{1}
\setlist[probitemize]{label=\textbullet,nosep}
\newlist{pardescription}{description}{1}
\setlist[pardescription]{nosep,topsep=-0.75\parskip}

% Chapter styling
\usepackage{quotchap}
\makeatletter
\renewcommand*{\chapnumfont}{%
  \usefont{T1}{\@defaultcnfont}{b}{n}\fontsize{80}{100}\selectfont% Default: 100/130
  \color{midpurple}%
}
\makeatother

% Show oferfull boxes and lines
\overfullrule=2pt

% Code snippets
\usepackage{minted}
\newcommand{\filename}[1]{\texttt{#1}}  % inline file name
\newcommand{\code}[1]{\texttt{#1}}      % inline code snippet
\newcommand{\hspackage}[1]{\href{http://hackage.haskell.org/package/#1}{\texttt{#1}}}

% Title and Author
\usepackage{titling}
\title{Haskell Spaceflight Workshop}
\author{Jonathan Merritt \and Luke Clifton}
\date{YOW! LambdaJam 2019, May 13--15}

% Glossary of mathematical symbols
\usepackage{siunitx}
\sisetup{per-mode = symbol}
\usepackage[symbols,nogroupskip]{glossaries-extra}
\glsxtrnewsymbol[description={A function.}]{f}{\ensuremath{f}}
\glsxtrnewsymbol[description={Total force, scalar (\si{N}).}]{Fs}{\ensuremath{F}}
\glsxtrnewsymbol[description={Time step (\si{s}).}]{dt}{\ensuremath{h}}
\glsxtrnewsymbol[description={Spring constant (\si{N/m}).}]{k}{\ensuremath{k}}
\glsxtrnewsymbol[description={Mass (\si{kg}).}]{m}{\ensuremath{m}}
\glsxtrnewsymbol[description={Number of moles of a substance.}]{N}{\ensuremath{N}}
\glsxtrnewsymbol[description={Number of moles of a substance at \(t=0\).}]{N0}{\ensuremath{N_0}}
\glsxtrnewsymbol[description={Position, scalar (\si{m}).}]{rs}{\ensuremath{r}}
\glsxtrnewsymbol[description={Position, scalar, at \(t=0\) (\si{m}).}]{rs0}{\ensuremath{r_0}}
\glsxtrnewsymbol[description={Time (\si{\s}).}]{t}{\ensuremath{t}}
\glsxtrnewsymbol[description={Radioactive half life (\si{\s}).}]{thalf}{\ensuremath{t_{\frac{1}{2}}}}
\glsxtrnewsymbol[description={Velocity, scalar (\si{m/s}).}]{vs}{\ensuremath{v}}
\glsxtrnewsymbol[description={System state vector.}]{stvec}{\ensuremath{\mathbf{x}}}
\glsxtrnewsymbol[description={Radioactive decay constant (\si{\per\s}).}]{lambda}{\ensuremath{\lambda}}
\glsxtrnewsymbol[description={Angular frequency (\si{\per\s}).}]{omega}{\ensuremath{\omega}}

%------------------------------------------------------------------------------
% DOCUMENT
%------------------------------------------------------------------------------
\begin{document}

% Customized title page with a nice logo
\begin{titlepage}
\begin{center}
  \vspace*{1.5cm}
  {\Huge\textsf{\MakeUppercase{\thetitle}}}\par
  \vspace{1.cm}
  \includegraphics[width=0.8\textwidth]{fig/logo-text.pdf}\par
  \vspace{1.cm}
  {\Large\textsf{\theauthor}}\par
  \vspace{0.2em}
  {\Large\textsf{\thedate}}\par           
  \vspace{0.5cm}
  \rule{2cm}{0.5pt}\\\vspace{0.2cm}
  \textsf{Version timestamp: PUBDATE}
\end{center}
\end{titlepage}

\tableofcontents

\chapter{Introduction}

In this workshop, we take an enthusiastic numerical approach to simulating spacecraft maneuvers. Our workshop examples appear in the published literature, yet we must begin by stating that there are often more elegant solutions to the problems we describe, allowing results to be found more economically and precisely. For these solutions, we must refer readers to a comprehensive textbook on astrodynamics (eg.~\cite{battin1999}). We have chosen to take our somewhat simplified numerical approach for the following reasons:
\begin{enumerate}
\item It makes a 90 minute workshop possible, where an exploration of tailored methods would require weeks of work,
\item It allows us to frame several problems as initial value problems of ODE integration,
\item It introduces techniques that are widely applicable to dynamical systems outside of spaceflight, and
\item We believe it provides a good introduction, motivating more sophisticated approaches quite naturally as individuals explore further.
\end{enumerate}

\chapter{ODE Integration and Initial Value Problems}

The models we use for a spacecraft depend upon a set of variables that represent its state at an instant in time. These state variables typically include:
\begin{paritemize}
\item Position
\item Velocity
\item Mass
\end{paritemize}
They may be scalar quantities or vectors, as appropriate to the problem.

Our simulations are all examples of ``Initial Value Problems''. In an initial value problem, we know the starting state of the spacecraft, and we have a set of first-order ordinary differential equations (ODEs), which describe how its state evolves with time. We will integrate these ODEs to predict the state at future times. Using this approach, we can compute the time history of state variables that are critial to mission or maneuver planning. For example, we might find the trajectory of a spacecraft (its position as a function of time), and check whether it places the spacecraft in a desired orbit.

The motion of a spacecraft depends on multiple forces that might be acting on it. For example:
\begin{paritemize}
\item Gravity
\item Atmospheric drag
\item Rocket thrust
\end{paritemize}
Thrust from a rocket engine may be controlled, and control inputs can be modeled easily in our system. Testing the behavior of a control system, particularly under conditions of real-world variations, is a modern practical use of the methods we cover (eg.~\cite{prince2011, brauer1977}).

\section{Euler's Method}

We can write a set of coupled, first-order ODEs as:
\begin{align}
  \frac{d\gls{stvec}}{d\gls{t}} &= \dot{\gls{stvec}} = \gls{f}(\gls{t}, \gls{stvec})
\end{align}
Here, \gls{stvec} is the state vector, \gls{t} is time, and \gls{f} is some function. In Euler's method, we approximate a step forward in time by multiplying the gradient by the size of the time step, \gls{dt}:
\begin{align}
  \gls{stvec}(\gls{t} + \gls{dt})
  &\approx \gls{stvec}(\gls{t}) + \dot{\gls{stvec}}\,\gls{dt} \\
  &\approx \gls{stvec}(\gls{t}) + \gls{f}\left(\gls{t}, \gls{stvec}(\gls{t})\right)\,\gls{dt}
\end{align}

\subsection{Radioactive Decay}

We will begin implementing Euler's method, specialized to \code{Double}, using the process of radioactive decay as an example. Radioactive decay is simple enough to solve analytically, thus providing a comparison with the numerical result, and it only involves a single state variable (\gls{N}), which can be represented as a \code{Double}. Specializing to \code{Double} also gives us a simple starting point that is representative of the approach used in many other programming languages.

In radioactive decay, the rate of decay, \(\dot{\gls{N}}\), is proportional to the number of moles of radioactive particles that remain at any instant in time, \gls{N}:
\begin{align}
  \dot{\gls{N}} &= -\gls{lambda}\gls{N}
\end{align}
where \gls{lambda} is called the decay constant. This equation can be solved by knowing in advance that an exponential function happens to fit exactly the expected equation:
\begin{align}
  \gls{N} &= \gls{N0} \exp\left({-\gls{lambda}\gls{t}}\right)
\end{align}
So that:
\begin{align}
  \dot{\gls{N}} &= -\gls{lambda}\left(\gls{N0}\exp\left({-\gls{lambda}\gls{t}}\right)\right) \\
                &= -\gls{lambda}\gls{N}
\end{align}
as required. Conventionally, \gls{lambda} is specified in terms of the half-life of an isotope, \gls{thalf}:
\begin{align}
  \textrm{at } \gls{t} &= 0,\: \gls{N} = \gls{N0} \\
  \textrm{at } \gls{t} &= \gls{thalf},\: \gls{N} = \frac{\gls{N0}}{2}
\end{align}
thus:
\begin{align}
  \frac{\gls{N0}}{2} &= \gls{N0}\exp\left({-\gls{lambda}\gls{thalf}}\right) \\
  \ln\left(\frac{1}{2}\right) &= -\gls{lambda}\gls{thalf} \\
  \gls{lambda} &= \frac{\ln 2}{\gls{thalf}}
\end{align}
As an example, consider the isotope Plutonium-238 (\isotope[238]{Pu}), which has been used in radioisotope thermoelectric generators (RTGs) for spacecraft such as the Voyager 1 and 2 probes. This isotope has a half-life of approximately 87.7 years.

\begin{problem}[label=eulerStepDouble]{Euler integration specialized to \code{Double}.}
  In the file \filename{ODE.hs},
  \begin{probitemize}
  \item implement \code{eulerStepDouble}, which takes a single step of Euler integration
  \item implement \code{integrateEulerDouble}, which takes multiple steps
  \end{probitemize}
  In \filename{ODEExamples.hs},
  \begin{probitemize}
  \item run \code{plotEulerDoubleExpDecay Screen}, to view a plot of Euler integration applied to the radioactive decay example
  \end{probitemize}
\end{problem}

\begin{figure}[htbp]
  \centering
  \resizebox{\textwidth}{!}{\input{fig/euler-double-exp-decay}}
  \caption{Comparison of Euler integration with the analytical result for radioactive decay of the isotope \isotope[238]{Pu}. The solid line shows the analytical solution while the points demonstrate the Euler approximation for different time steps.}
  \label{fig:euler-double-exp-decay}
\end{figure}

Figure~\ref{fig:euler-double-exp-decay} shows the result of applying Euler integration to the radioactive decay example. In this figure, it is evident that when smaller time-steps are taken, the Euler method more closely approximates the analytical solution. This is usually the case practically with numerical integration, although there is a limit beyond which smaller time steps will begin to diverge from the correct solution due to accruing floating-point errors. We will see later that raising the polynomial order of the integration approximation can improve accuracy with greater computational efficiency than taking smaller time steps.

\section{Generalizing Euler's Method}

We will now generalize Euler's method using the abstractions available in the \hspackage{vector-space} package. The necessary constraints are captured in Listing~\ref{lst:euler-vector-space}. Don't panic if this seems a lot to take in, since we'll see a few concrete examples.

\begin{listing}[htbp]
\begin{minted}[fontsize=\small]{haskell}
eulerStep
  :: ( AffineSpace state
     , diff ~ Diff state, VectorSpace diff
     , HasBasis time, HasTrie (Basis time)
     , s ~ Scalar diff, s ~ Scalar time )
  => time                              -- ^ Step size @dt@
  -> ((time, state) -> time :-* diff)  -- ^ Gradient function @f (x, t)@
  -> (time, state)                     -- ^ Before the step @(t, x)@
  -> (time, state)                     -- ^ After the step @(t, x)@
\end{minted}
\caption{Constraints for Euler's method generalized by \hspackage{vector-space}.}
\label{lst:euler-vector-space}
\end{listing}

The first concept we introduce is the difference between an \code{AffineSpace} and its associated \code{VectorSpace}. In the present context, points in the \code{AffineSpace} are points belonging to the state space of the problem, of type \code{state}. Vectors of the associated \code{VectorSpace}, of type \code{diff}, represent deltas or differences between the points. We can add a vector to a point to obtain a new point, but we don't sum points directly. Most widely-used frameworks for numerical integration do not make this distinction.

Next is the concept of a linear map representing the derivative: \code{time :-* diff}. In our case, where we deal with finite differences, this constructor can be considered analogous to a function of type \code{time -> diff}, but constrained to be linear. A very simple illustration of the linear map is shown in Listing~\ref{lst:linear-map-scalar}. The \code{linear} function assumes that the function it has been provided is linear, and it memoizes the values of that function along each basis vector of the vector space.

\begin{listing}[htbp]
\begin{minted}[fontsize=\small]{haskell}
> :set -XFlexibleContexts
> import Data.LinearMap ((:-*), linear, lapply)
> f = (*) 5 :: Double -> Double
> lm = linear f
> :t lm
lm :: Double :-* Double
> lapply lm 1
5.0
> lapply lm 2
10.0
\end{minted}
\caption{Illustration of a simple, scalar linear map.}
\label{lst:linear-map-scalar}
\end{listing}

Finally, we need to describe the operations that can be used on instances of \code{AffineSpace} and its associated \code{VectorSpace}:
\begin{pardescription}[leftmargin=6em,style=nextline]
\item [\code{lapply m h}] applies linear map \code{m} to vector \code{h}
\item [\code{p .+\^{} v}] adds vector \code{v} to point \code{p}
\item [\code{a \^{}+\^{} b}] adds vector \code{a} to vector \code{b}
\end{pardescription}
These operations are sufficient to implement the generalized form of Euler's method.

\subsection{Simple Harmonic Motion}

To motivate the generalized form of Euler's method, let's consider simple harmonic motion (SHM), with two scalar state variables:
\begin{paritemize}
\item Position, \gls{rs}
\item Velocity, \gls{vs}
\end{paritemize}
The data type \code{State} in \filename{ODEExamples.hs} describes this state, which is the \code{AffineSpace} of the problem. It introduces statically type-checked units from the \hspackage{units} package for length and velocity. The data type \code{DState} is the correspondng \code{VectorSpace} of the problem, representing deltas in the state.

In SHM, a linear spring force, \gls{Fs}, is proportional to the position:
\begin{align}
  \gls{Fs} &= -\gls{k}\gls{rs}
\end{align}
This is combined with the equations of motion of a point mass to produce the following governing ODE:
\begin{align}
  \dot{\gls{stvec}} =
  \begin{bmatrix}\dot{\gls{rs}}\\\dot{\gls{vs}}\end{bmatrix} &=
  \begin{bmatrix}\gls{vs}\\-k\gls{rs}/\gls{m}\end{bmatrix}
\end{align}
If the initial conditions of the problem at \(\gls{t} = 0\) are \(\gls{rs} = \gls{rs0}\) and \(\gls{vs} = 0\) then the analytical solution is:
\begin{align}
  \gls{stvec}(t) &=
  \begin{bmatrix}
    \gls{rs0}\cos(\gls{omega}t) \\
    -\gls{omega}\gls{rs0}\sin(\gls{omega}t)
  \end{bmatrix}
\end{align}
where the angular velocity, \gls{omega}, is:
\begin{align}
  \gls{omega} &= \sqrt{\frac{\gls{k}}{\gls{m}}}
\end{align}

\begin{problem}[label=eulerStepVectorSpace]{Generalized Euler integration.}
  In the file \filename{ODE.hs},
  \begin{probitemize}
  \item implement \code{eulerStep}
  \item implement \code{integrate} and \code{integrateWithDiff}
  \end{probitemize}
  In \filename{ODEExamples.hs},
  \begin{probitemize}
  \item run \code{plotEulerSHM Screen}, to view a plot of the position state variable, computed by Euler integration of SHM equations
  \end{probitemize}
\end{problem}

\begin{figure}[htbp]
  \resizebox{\textwidth}{!}{\input{fig/euler-shm}}
  \caption{Comparison of Euler integration with the analytical result for the position variable of a simple harmonic oscillator. The solid line shows the analytical solution while the points demonstrate the Euler approximation for different time steps.}
  \label{fig:euler-shm}
\end{figure}

Figure~\ref{fig:euler-shm} shows the position variable of a simple harmonic oscillator example. Once again, the smaller the time step, the more closely the result tracks the analytical solution.

% Symbol Glossary
\printunsrtglossary[type=symbols,style=long]

% References
\clearpage\phantomsection
\addcontentsline{toc}{chapter}{References}
\bibliographystyle{IEEEtran}
\bibliography{references.bib}

\end{document}
